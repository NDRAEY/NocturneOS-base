name: Autobuild

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[no ci]')"
    steps:
      - uses: actions/checkout@v3

      - name: Just lists all version of clang
        run: sudo apt list "clang-*"

      - name: Step 1 - Software installation
        run: |
          sudo apt install python3 build-essential xorriso grub-pc-bin mtools llvm lld doxygen ninja-build cmake

      - name: Step 1.1 - Install Rust
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- --default-toolchain nightly -y

      - name: Step 1.2 - Install toolchain
        run: rustup toolchain install nightly-2023-04-11 && rustup component add rust-src --toolchain nightly-2023-04-11-x86_64-unknown-linux-gnu

      - name: Step 2 - Compiling the kernel
        run: bash tools/make_builds.sh

      - name: Step 3.1 - Build Debug build
        run: cmake --build cmake-build-debug/ -j4 -- iso

      - name: Step 3.1 - Build Release build
        run: cmake --build cmake-build-release/ -j4 -- iso

      - name: Step 3.1 - Build ReleaseOptimized build
        run: cmake --build cmake-build-release-opt/ -j4 -- iso

      - name: Step 8 - Update to the latest unstable release
        uses: "marvinpinto/action-automatic-releases@latest"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest-unstable"
          prerelease: true
          title: "üíΩ SayoriOS Soul- [–ê–≤—Ç–æ—Å–±–æ—Ä–∫–∞] –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–µ–ª–∏–∑"
          description: "–í–Ω–∏–º–∞–Ω–∏–µ! –î–∞–Ω–Ω—ã–π —Ä–µ–ª–∏–∑ —Å–æ–±—Ä–∞–Ω –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —è–¥—Ä–µ! –≠—Ç–æ –Ω–µ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏ –∏ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –∑–∞–ø—É—Å–∫—É –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ."
          files: |
            cmake-build-debug/NocturneOS_Debug.iso
            cmake-build-release/NocturneOS_Release.iso
            cmake-build-release-opt/NocturneOS_ReleaseOptimized.iso
